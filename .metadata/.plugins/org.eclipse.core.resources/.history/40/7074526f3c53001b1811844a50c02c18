package com.ordereat.OrderEat.Repository;

import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;
import javax.transaction.Transactional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import com.ordereat.OrderEat.Entity.CombinedRegistrationEntity;
import com.ordereat.OrderEat.Entity.RestaurantDetails;
import com.ordereat.OrderEat.Entity.RestaurantOwner;

@Repository
@Transactional
public class RestaurantOwnerRespositoryImpl implements RestaurantOwnerRepository {

	@Autowired
	EntityManager entityManager;
	
	@Override
	public RestaurantOwner findRestaurantOwnerById(Long id) {
		TypedQuery<RestaurantOwner> typedQuery
	      = entityManager.createQuery("SELECT owner FROM RestaurantOwner owner where owner.id = :id", RestaurantOwner.class);
	    typedQuery.setParameter("id", id);
	    return typedQuery.getSingleResult();
	}

	@Override
	public void registerRestaurantOwnerAndRestaurant(CombinedRegistrationEntity combinedRegistrationEntity) {
		// TODO Auto-generated method stub
		RestaurantDetails restaurantDetails = new RestaurantDetails(combinedRegistrationEntity.getRestaurantDetails().getRestaurantName());
		RestaurantOwner restaurantOwner = new RestaurantOwner();
		restaurantOwner.setEmail(combinedRegistrationEntity.getRestaurantOwner().getEmail());
		restaurantOwner.setFullName(combinedRegistrationEntity.getRestaurantOwner().getFullName());
		restaurantOwner.setPassword(combinedRegistrationEntity.getRestaurantOwner().getPassword());
		restaurantOwner.setPhoneNumber(combinedRegistrationEntity.getRestaurantOwner().getPhoneNumber());
		restaurantOwner.setUsername(combinedRegistrationEntity.getRestaurantOwner().getUsername());
		
		restaurantOwner.setRestaurantDetails(restaurantDetails);
		restaurantDetails.setRestaurantOwner(restaurantOwner);
		
		entityManager.persist(restaurantOwner);
		entityManager.flush();
	}

	@Override
	public List<RestaurantOwner> findAllRestaurantOwner() {
		// TODO Auto-generated method stub
		TypedQuery<RestaurantOwner> typedQuery
	      = entityManager.createQuery("SELECT owner FROM RestaurantOwner owner", RestaurantOwner.class);
	    return typedQuery.getResultList();
	}

	@Override
	public boolean findIfExists(CombinedRegistrationEntity combinedEntity) {
		// TODO Auto-generated method stub
		String restaurantOwnerQuery = "Select user from RestaurantOwner user where email = :email";
		TypedQuery<RestaurantOwner> typedQuery = entityManager.createQuery(restaurantOwnerQuery, RestaurantOwner.class);
		typedQuery.setParameter("email", combinedEntity.getRestaurantOwner().getEmail());
		if(typedQuery.getResultList().size() > 0)
			return true;
		return false;
	}

	@Override
	public RestaurantOwner getOnwerFromRestaurantId(Long id) {
		String query = "Select ownerDetails from RestaurantOwner ownerDetails where restaurant_id = : restaurant_id";
		TypedQuery<RestaurantOwner> typedQuery
	      = entityManager.createQuery(query, RestaurantOwner.class);
		typedQuery.setParameter("restaurant_id", id);
	    return typedQuery.getSingleResult();
	}
	
	@Override
	public boolean findIfRestaurantExists(Long id) {
		String query = "Select restaurant From RestaurantDetails restaurant where id = :id";
		TypedQuery<RestaurantDetails> typedQuery = entityManager.createQuery(query, RestaurantDetails.class);
		typedQuery.setParameter("id", id);
		if(typedQuery.getResultList().size() > 0) {
			return true;
		}
		return false;
	}

	@Override
	public RestaurantDetails updateRestaurantDetails(RestaurantDetails restaurantDetails) {
		RestaurantOwner owner = getOnwerFromRestaurantId(restaurantDetails.getId());
		owner.setRestaurantDetails(restaurantDetails);
		restaurantDetails.setRestaurantOwner(owner);
		entityManager.merge(owner);
		entityManager.flush();
		return entityManager.find(RestaurantDetails.class, restaurantDetails.getId());
	}
	
	@Override
	public boolean findIfRestaurantOwnerExists(Long id) {
		String query = "Select owner From RestaurantOwner owner where id = :id";
		TypedQuery<RestaurantOwner> typedQuery = entityManager.createQuery(query, RestaurantOwner.class);
		typedQuery.setParameter("id", id);
		if(typedQuery.getResultList().size() > 0) {
			return true;
		}
		return false;
	}

	@Override
	public RestaurantOwner updateRestaurantOwner(RestaurantOwner restaurantOwner) {
		RestaurantDetails restaurantDetails = restaurantOwner.getRestaurantDetails();
		restaurantDetails.setRestaurantOwner(restaurantOwner);
		restaurantOwner.setRestaurantDetails(restaurantDetails);
		entityManager.merge(restaurantOwner);
		entityManager.flush();
		return entityManager.find(RestaurantOwner.class, restaurantOwner.getId());
	}

	public CombinedRegistrationEntity getOwnerAndRestaurantDetails(RestaurantOwner restaurantOwner) {
		String query = "Select owner from RestaurantOwner owner where id = : id";
		TypedQuery<RestaurantOwner> typedQuery
	      = entityManager.createQuery(query, RestaurantOwner.class);
		typedQuery.setParameter("id", restaurantOwner.getId());
	    RestaurantOwner extractedOwner = typedQuery.getSingleResult();
	    String detailsQuery = "Select details from RestaurantDetails details where id = :id";
	    TypedQuery<RestaurantDetails> typedQuery2
	      = entityManager.createQuery(detailsQuery, RestaurantDetails.class);
		typedQuery2.setParameter("id", restaurantOwner.getRestaurantDetails().getId());
	    RestaurantDetails extractedDetails = typedQuery2.getSingleResult();
	    
	    CombinedRegistrationEntity combinedRegistrationEntity = new CombinedRegistrationEntity(extractedDetails, extractedOwner);
	}
}
